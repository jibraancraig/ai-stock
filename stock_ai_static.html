<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Machine Learning AI Investor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Montserrat", sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(
          135deg,
          #0f0f0f 0%,
          #1a0f0f 25%,
          #2d1b1b 50%,
          #3d2b2b 75%,
          #4d3b3b 100%
        );
        color: #ffffff;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        background: transparent;
        padding: 0;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header Styling */
      .header-container {
        text-align: center;
        padding: 2rem 0 1rem 0;
        position: relative;
      }

      .main-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #8b0000;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .creator-signature {
        position: absolute;
        top: 1rem;
        right: 2rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 400;
      }

      /* Search Section */
      .search-section {
        background: rgba(45, 27, 27, 0.8);
        border: 1px solid rgba(139, 0, 0, 0.4);
        border-radius: 15px;
        padding: 1.5rem;
        margin: 0 2rem 2rem 2rem;
        box-shadow: 0 8px 32px rgba(139, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      .search-title {
        color: #8b0000;
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .search-input-group {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .search-input {
        flex: 1;
        background: rgba(45, 27, 27, 0.9);
        border: 1px solid rgba(139, 0, 0, 0.5);
        border-radius: 10px;
        color: #ffffff;
        font-weight: 400;
        padding: 0.75rem 1rem;
        font-size: 1rem;
      }

      .search-input:focus {
        outline: none;
        border-color: #8b0000;
        box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.25);
      }

      .search-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .analyze-btn {
        background: #8b0000;
        border: none;
        border-radius: 10px;
        color: #ffffff;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .analyze-btn:hover {
        background: #a00000;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
      }

      .analyze-btn:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Filter Section */
      .filter-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(139, 0, 0, 0.3);
      }

      .filter-title {
        color: #8b0000;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .filter-btn {
        background: rgba(45, 27, 27, 0.9);
        border: 1px solid rgba(139, 0, 0, 0.5);
        border-radius: 8px;
        color: #ffffff;
        font-weight: 500;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: rgba(139, 0, 0, 0.3);
        border-color: #8b0000;
      }

      .filter-btn-active {
        background: #8b0000;
        border-color: #8b0000;
        box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
      }

      .filter-btn-active:hover {
        background: #a00000;
      }

      /* Stock List Section */
      .stock-list-section {
        background: rgba(45, 27, 27, 0.9);
        border: 1px solid rgba(139, 0, 0, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin: 0 2rem 2rem 2rem;
        box-shadow: 0 8px 32px rgba(139, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      .stock-list-title {
        color: #8b0000;
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stock-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }

      .stock-item {
        background: rgba(45, 27, 27, 0.8);
        border: 1px solid rgba(139, 0, 0, 0.3);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .stock-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        border-color: #8b0000;
      }

      .stock-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .stock-symbol {
        font-weight: 700;
        font-size: 1.125rem;
        color: #ffffff;
      }

      .stock-recommendation {
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .recommendation-buy {
        background: rgba(40, 167, 69, 0.2);
        color: #4ade80;
        border: 1px solid #4ade80;
      }

      .recommendation-hold {
        background: rgba(255, 193, 7, 0.2);
        color: #fbbf24;
        border: 1px solid #fbbf24;
      }

      .recommendation-sell {
        background: rgba(220, 53, 69, 0.2);
        color: #f87171;
        border: 1px solid #f87171;
      }

      .stock-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        font-size: 0.875rem;
      }

      .stock-detail {
        color: #ffffff;
      }

      .stock-detail-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.75rem;
      }

      /* Cards Grid */
      .cards-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        padding: 0 2rem 2rem 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .card {
        background: rgba(45, 27, 27, 0.9);
        border: 1px solid rgba(139, 0, 0, 0.3);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(139, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        min-height: 300px;
        display: flex;
        flex-direction: column;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(139, 0, 0, 0.3);
      }

      .card-header {
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        border-bottom: 1px solid rgba(139, 0, 0, 0.2);
      }

      .card-title {
        color: #8b0000;
        font-weight: 600;
        font-size: 1.25rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .card-body {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .card-content {
        flex: 1;
      }

      /* Typography */
      .bold-number {
        font-weight: 700;
        color: #8b0000;
      }

      .bold-text {
        font-weight: 600;
        color: #ffffff;
      }

      .regular-text {
        color: #ffffff;
        font-weight: 400;
        margin-bottom: 0.75rem;
      }

      /* Alert Styling */
      .alert {
        border-radius: 10px;
        border: none;
        font-weight: 500;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .alert-success {
        background: rgba(40, 167, 69, 0.2);
        color: #4ade80;
        border-left: 4px solid #4ade80;
      }

      .alert-danger {
        background: rgba(220, 53, 69, 0.2);
        color: #f87171;
        border-left: 4px solid #f87171;
      }

      .alert-warning {
        background: rgba(255, 193, 7, 0.2);
        color: #fbbf24;
        border-left: 4px solid #fbbf24;
      }

      /* List Styling */
      ul {
        list-style: none;
        padding-left: 0;
      }

      li {
        color: #ffffff;
        margin-bottom: 0.5rem;
        padding-left: 1rem;
        position: relative;
      }

      li:before {
        content: "•";
        color: #8b0000;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      /* Chart Container */
      .chart-container {
        background: rgba(45, 27, 27, 0.9);
        border: 1px solid rgba(139, 0, 0, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin: 0 2rem 2rem 2rem;
        box-shadow: 0 8px 32px rgba(139, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        height: 500px;
        position: relative;
      }

      .chart-wrapper {
        height: 400px;
        width: 100%;
        position: relative;
      }

      .chart-title {
        color: #8b0000;
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Loading Animation */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(139, 0, 0, 0.3);
        border-radius: 50%;
        border-top-color: #8b0000;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-container {
        text-align: center;
        color: #ff6b6b;
        padding: 2rem;
      }

      /* Error Styling */
      .error-message {
        background: rgba(220, 53, 69, 0.2);
        color: #f87171;
        border-left: 4px solid #f87171;
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .cards-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
          padding: 0 1rem 1rem 1rem;
        }

        .search-section {
          margin: 0 1rem 1.5rem 1rem;
        }

        .search-input-group {
          flex-direction: column;
          gap: 0.75rem;
        }

        .main-title {
          font-size: 2rem;
        }

        .creator-signature {
          position: static;
          text-align: center;
          margin-top: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header-container">
        <h1 class="main-title">📈 Machine Learning AI Investor</h1>
        <div class="creator-signature">Made by Jibraan Craig</div>
      </div>

      <!-- Search Section -->
      <div class="search-section">
        <h5 class="search-title">🔍 Stock Analysis</h5>
        <div class="search-input-group">
          <input
            type="text"
            id="symbol-input"
            class="search-input"
            placeholder="Please search any stock symbol (e.g AAPL)"
            value="AAPL"
          />
          <button id="analyze-btn" class="analyze-btn">Analyse</button>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
          <h6 class="filter-title">🎯 Filter by Recommendation</h6>
          <div class="filter-buttons">
            <button id="filter-all" class="filter-btn filter-btn-active">
              All
            </button>
            <button id="filter-buy" class="filter-btn">BUY</button>
            <button id="filter-hold" class="filter-btn">HOLD</button>
            <button id="filter-sell" class="filter-btn">SELL</button>
          </div>
        </div>
      </div>

      <!-- Loading Output -->
      <div id="loading-output"></div>

      <!-- Stock List Section -->
      <div
        id="stock-list-section"
        class="stock-list-section"
        style="display: none"
      >
        <h5 class="stock-list-title">📈 Stock Recommendations</h5>
        <div id="stock-list" class="stock-list">
          <!-- Stock items will be populated here -->
        </div>
      </div>

      <!-- Chart Container -->
      <div id="chart-container" class="chart-container" style="display: none">
        <h5 class="chart-title">📊 Price Chart</h5>
        <div class="chart-wrapper">
          <canvas id="price-chart"></canvas>
        </div>
      </div>

      <!-- Cards Grid -->
      <div class="cards-grid">
        <!-- Top Left Card - Stock Info -->
        <div class="card">
          <div class="card-header">
            <h5 id="stock-title" class="card-title">📊 AAPL - Apple Inc.</h5>
          </div>
          <div id="stock-info-card" class="card-body">
            <div class="card-content">
              <p class="regular-text">
                💰 Current Price: <span class="bold-number">$0.00</span>
              </p>
              <p class="regular-text">
                📈 Market Cap: <span class="bold-number">$0</span>
              </p>
              <p class="regular-text">
                🏢 Sector: <span class="bold-text">N/A</span>
              </p>
              <p class="regular-text">
                📅 Data Points: <span class="bold-number">0 days</span>
              </p>
              <p class="regular-text">
                📊 Volume: <span class="bold-number">0</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Top Right Card - Trading Recommendation -->
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">🎯 Trading Recommendation</h5>
          </div>
          <div id="recommendation-card" class="card-body">
            <div class="card-content">
              <div class="alert alert-warning">HOLD - Confidence: 0%</div>
              <h6
                class="bold-text"
                style="margin-top: 1rem; margin-bottom: 0.5rem"
              >
                Key Signals:
              </h6>
              <ul>
                <li>Enter a stock symbol to get analysis</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Bottom Left Card - Technical Analysis -->
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">📈 Technical Analysis</h5>
          </div>
          <div id="technical-content" class="card-body">
            <div class="card-content">
              <p class="regular-text">
                RSI: <span class="bold-number">0.0</span>
              </p>
              <p class="regular-text">
                Price Change (20d): <span class="bold-number">0.0%</span>
              </p>
              <p class="regular-text">
                Volume Ratio: <span class="bold-number">0.0x average</span>
              </p>
              <p class="regular-text">
                MACD: <span class="bold-number">0.000</span>
              </p>
              <p class="regular-text">
                Data Quality: <span class="bold-text">No data</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Bottom Right Card - Risk Assessment -->
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">⚠️ Risk Assessment</h5>
          </div>
          <div id="risk-content" class="card-body">
            <div class="card-content">
              <div class="alert alert-warning">Risk Level: Unknown</div>
              <p class="regular-text">
                Volatility: <span class="bold-number">0.0%</span>
              </p>
              <p class="regular-text">
                Max Drawdown: <span class="bold-number">0.0%</span>
              </p>
              <p class="regular-text">
                Sharpe Ratio: <span class="bold-number">0.00</span>
              </p>
              <p class="regular-text">
                Beta: <span class="bold-text">N/A</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentChart = null
      let stockData = null
      let allStocksData = [] // Store all analyzed stocks
      let currentFilter = "all" // Current filter state

      // DOM elements
      const symbolInput = document.getElementById("symbol-input")
      const analyzeBtn = document.getElementById("analyze-btn")
      const loadingOutput = document.getElementById("loading-output")
      const stockTitle = document.getElementById("stock-title")
      const stockInfoCard = document.getElementById("stock-info-card")
      const recommendationCard = document.getElementById("recommendation-card")
      const technicalContent = document.getElementById("technical-content")
      const riskContent = document.getElementById("risk-content")
      const chartContainer = document.getElementById("chart-container")
      const priceChart = document.getElementById("price-chart")

      // Filter elements
      const filterAll = document.getElementById("filter-all")
      const filterBuy = document.getElementById("filter-buy")
      const filterHold = document.getElementById("filter-hold")
      const filterSell = document.getElementById("filter-sell")
      const stockListSection = document.getElementById("stock-list-section")
      const stockList = document.getElementById("stock-list")

      // Event listeners
      analyzeBtn.addEventListener("click", analyzeStock)
      symbolInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          analyzeStock()
        }
      })

      // Filter event listeners
      filterAll.addEventListener("click", () => setFilter("all"))
      filterBuy.addEventListener("click", () => setFilter("buy"))
      filterHold.addEventListener("click", () => setFilter("hold"))
      filterSell.addEventListener("click", () => setFilter("sell"))

      // Main analysis function
      async function analyzeStock() {
        const symbol = symbolInput.value.trim().toUpperCase()
        if (!symbol) {
          showError("Please enter a stock symbol")
          return
        }

        showLoading("Fetching stock data...")
        analyzeBtn.disabled = true

        try {
          // Fetch stock data
          const data = await fetchStockData(symbol)
          if (!data || data.length === 0) {
            throw new Error("No data found for this symbol")
          }

          stockData = data

          // Fetch fundamental data for comprehensive analysis
          const fundamentalData = await fetchFundamentalData(symbol)

          // Generate recommendation for storage
          const recommendation = generateRecommendation(data)

          // Store stock data with recommendation
          const stockInfo = {
            symbol: symbol,
            data: data,
            recommendation: recommendation.recommendation,
            confidence: recommendation.confidence,
            price: data[data.length - 1].close,
            priceChange: recommendation.price_change,
            rsi: recommendation.rsi,
            volumeRatio: recommendation.volume_ratio,
            fundamentalData: fundamentalData, // Add fundamental data
          }

          // Add to all stocks data (or update if exists)
          const existingIndex = allStocksData.findIndex(
            (stock) => stock.symbol === symbol
          )
          if (existingIndex >= 0) {
            allStocksData[existingIndex] = stockInfo
          } else {
            allStocksData.push(stockInfo)
          }

          // Update UI
          updateStockInfo(symbol, data)
          updateRecommendation(data)
          updateTechnicalAnalysis(data)
          updateRiskAssessment(data)
          updateChart(symbol, data)
          updateStockTitle(symbol)
          updateStockList() // Update the stock list with new data

          hideLoading()
          analyzeBtn.disabled = false
        } catch (error) {
          showError(`Error: ${error.message}`)
          analyzeBtn.disabled = false
        }
      }

      // Enhanced data fetching with multiple API fallbacks
      async function fetchStockData(symbol) {
        const apis = [
          // Primary: Yahoo Finance (most reliable)
          async () => {
            const response = await fetch(
              `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1y`
            )
            const data = await response.json()
            if (data.chart?.result?.[0]) {
              const result = data.chart.result[0]
              const timestamps = result.timestamp
              const quotes = result.indicators.quote[0]

              const stockData = []
              for (let i = 0; i < timestamps.length; i++) {
                if (quotes.close[i] !== null) {
                  const date = new Date(timestamps[i] * 1000)
                  stockData.push({
                    date: date.toISOString().split("T")[0],
                    open: quotes.open[i] || quotes.close[i],
                    high: quotes.high[i] || quotes.close[i],
                    low: quotes.low[i] || quotes.close[i],
                    close: quotes.close[i],
                    volume: quotes.volume[i] || 1000000,
                  })
                }
              }
              return stockData.length > 50 ? stockData : null
            }
            return null
          },

          // Secondary: Alpha Vantage (if you have API key)
          async () => {
            // Uncomment and add your API key
            // const API_KEY = 'YOUR_ALPHA_VANTAGE_KEY'
            // const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${API_KEY}`)
            // const data = await response.json()
            // Process Alpha Vantage data...
            return null
          },

          // Tertiary: IEX Cloud (if you have API key)
          async () => {
            // Uncomment and add your API key
            // const API_KEY = 'YOUR_IEX_CLOUD_KEY'
            // const response = await fetch(`https://cloud.iexapis.com/stable/stock/${symbol}/chart/1y?token=${API_KEY}`)
            // const data = await response.json()
            // Process IEX data...
            return null
          },
        ]

        // Try each API in sequence
        for (const api of apis) {
          try {
            const data = await api()
            if (data && data.length > 50) {
              console.log(
                `Successfully fetched real data for ${symbol} from ${api.name}`
              )
              return data
            }
          } catch (error) {
            console.log(`API failed for ${symbol}:`, error.message)
            continue
          }
        }

        // If all APIs fail, throw error instead of using mock data
        throw new Error(
          `Unable to fetch real data for ${symbol}. Please check your internet connection and try again.`
        )
      }

      // Fetch fundamental data for comprehensive analysis
      async function fetchFundamentalData(symbol) {
        try {
          const response = await fetch(
            `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=financialData,defaultKeyStatistics,summaryDetail`
          )
          const data = await response.json()

          if (data.quoteSummary?.result?.[0]) {
            const result = data.quoteSummary.result[0]
            const financialData = result.financialData || {}
            const keyStats = result.defaultKeyStatistics || {}
            const summary = result.summaryDetail || {}

            return {
              // Financial ratios
              peRatio: financialData.forwardPE || 0,
              pbRatio: financialData.priceToBook || 0,
              debtToEquity: financialData.debtToEquity || 0,
              returnOnEquity: financialData.returnOnEquity || 0,
              profitMargins: financialData.profitMargins || 0,

              // Market data
              marketCap: summary.marketCap || 0,
              enterpriseValue: summary.enterpriseValue || 0,
              beta: keyStats.beta || 1,

              // Growth metrics
              revenueGrowth: financialData.revenueGrowth || 0,
              earningsGrowth: financialData.earningsGrowth || 0,

              // Dividend info
              dividendYield: summary.dividendYield || 0,
              payoutRatio: financialData.payoutRatio || 0,
            }
          }
        } catch (error) {
          console.log(
            `Failed to fetch fundamental data for ${symbol}:`,
            error.message
          )
        }

        return null
      }

      // Generate realistic mock data based on actual market trends
      function generateMockData(symbol) {
        const days = 180
        const data = []

        // Realistic base prices (as of recent market data)
        const basePrices = {
          AAPL: 175,
          MSFT: 350,
          GOOGL: 140,
          AMZN: 180,
          TSLA: 250,
          NVDA: 800,
          META: 300,
          NFLX: 600,
        }

        let basePrice = basePrices[symbol] || 150 + Math.random() * 100

        // Realistic market trends (monthly returns)
        const monthlyTrends = {
          AAPL: 0.02, // ~2% monthly growth
          MSFT: 0.03, // ~3% monthly growth
          GOOGL: -0.01, // ~-1% monthly decline
          AMZN: 0.04, // ~4% monthly growth
          TSLA: -0.03, // ~-3% monthly decline
          NVDA: 0.05, // ~5% monthly growth
          META: 0.02, // ~2% monthly growth
          NFLX: -0.02, // ~-2% monthly decline
        }

        const monthlyTrend = monthlyTrends[symbol] || 0
        const dailyTrend = monthlyTrend / 30 // Convert to daily trend

        for (let i = 0; i < days; i++) {
          const date = new Date()
          date.setDate(date.getDate() - (days - i))

          // Realistic daily volatility (1-3% daily movement)
          const dailyVolatility = 0.015 + Math.random() * 0.01
          const randomChange = (Math.random() - 0.5) * dailyVolatility

          // Add trend component (much smaller)
          const trendChange = dailyTrend

          // Combine trend and random movement
          const totalChange = trendChange + randomChange
          basePrice *= 1 + totalChange

          // Ensure price stays within realistic bounds
          if (basePrice < 10) basePrice = 10
          if (basePrice > 2000) basePrice = 2000

          // Realistic OHLC data
          const dailyRange = basePrice * (0.005 + Math.random() * 0.01) // 0.5-1.5% daily range
          const open = basePrice * (1 + (Math.random() - 0.5) * 0.003)
          const close = basePrice
          const high = Math.max(open, close) + Math.random() * dailyRange
          const low = Math.min(open, close) - Math.random() * dailyRange

          // Realistic volume (varies by stock)
          const baseVolume =
            {
              AAPL: 50000000,
              MSFT: 30000000,
              GOOGL: 25000000,
              AMZN: 40000000,
              TSLA: 80000000,
              NVDA: 60000000,
              META: 35000000,
              NFLX: 20000000,
            }[symbol] || 30000000

          const volume = baseVolume * (0.5 + Math.random() * 1.0)

          data.push({
            date: date.toISOString().split("T")[0],
            open: open,
            high: high,
            low: low,
            close: close,
            volume: volume,
          })
        }

        return data
      }

      // Generate recommendation function
      function generateRecommendation(data) {
        if (data.length < 20) {
          return {
            recommendation: "HOLD",
            confidence: 0,
            signals: ["Insufficient data for analysis"],
            color: "warning",
            price_change: 0,
            rsi: 50,
            volume_ratio: 1,
          }
        }

        const latest = data[data.length - 1]
        const prev20 = data[Math.max(0, data.length - 21)]

        // Price trend
        const priceChange = ((latest.close - prev20.close) / prev20.close) * 100

        // RSI analysis
        const rsi = calculateRSI(data)

        // MACD analysis
        const macd = calculateMACD(data)

        // Volume analysis
        const avgVolume =
          data.reduce((sum, d) => sum + d.volume, 0) / data.length
        const currentVolume = latest.volume
        const volumeRatio = currentVolume / avgVolume

        // Generate recommendation
        let confidence = 0
        const signals = []

        if (priceChange > 5) {
          signals.push(`Strong uptrend (+${priceChange.toFixed(1)}%)`)
          confidence += 25
        } else if (priceChange > 0) {
          signals.push(`Slight uptrend (+${priceChange.toFixed(1)}%)`)
          confidence += 15
        } else if (priceChange < -5) {
          signals.push(`Strong downtrend (${priceChange.toFixed(1)}%)`)
          confidence -= 25
        } else {
          signals.push(`Sideways movement (${priceChange.toFixed(1)}%)`)
          confidence += 5
        }

        if (rsi < 30) {
          signals.push(`Oversold (RSI: ${rsi.toFixed(1)})`)
          confidence += 20
        } else if (rsi > 70) {
          signals.push(`Overbought (RSI: ${rsi.toFixed(1)})`)
          confidence -= 20
        }

        if (macd > 0) {
          signals.push("MACD bullish")
          confidence += 15
        } else {
          signals.push("MACD bearish")
          confidence -= 15
        }

        if (volumeRatio > 1.5) {
          signals.push(`High volume (${volumeRatio.toFixed(1)}x average)`)
          confidence += 10
        }

        // Determine recommendation
        let recommendation, color
        if (confidence > 20) {
          recommendation = "BUY"
          color = "success"
        } else if (confidence < -20) {
          recommendation = "SELL"
          color = "danger"
        } else {
          recommendation = "HOLD"
          color = "warning"
        }

        return {
          recommendation: recommendation,
          confidence: Math.abs(confidence),
          signals: signals,
          color: color,
          price_change: priceChange,
          rsi: rsi,
          volume_ratio: volumeRatio,
        }
      }

      // Calculate technical indicators
      function calculateIndicators(data) {
        const indicators = {
          rsi: calculateRSI(data),
          macd: calculateMACD(data),
          ma20: calculateMA(data, 20),
          ma50: calculateMA(data, 50),
          bb: calculateBollingerBands(data, 20),
        }
        return indicators
      }

      function calculateRSI(data, period = 14) {
        if (data.length < period + 1) return 50

        let gains = 0
        let losses = 0

        for (let i = 1; i <= period; i++) {
          const change =
            data[data.length - i].close - data[data.length - i - 1].close
          if (change > 0) gains += change
          else losses -= change
        }

        const avgGain = gains / period
        const avgLoss = losses / period
        const rs = avgGain / avgLoss
        return 100 - 100 / (1 + rs)
      }

      function calculateMACD(data) {
        const ema12 = calculateEMA(data, 12)
        const ema26 = calculateEMA(data, 26)
        return ema12 - ema26
      }

      function calculateEMA(data, period) {
        const multiplier = 2 / (period + 1)
        let ema = data[0].close

        for (let i = 1; i < data.length; i++) {
          ema = data[i].close * multiplier + ema * (1 - multiplier)
        }

        return ema
      }

      function calculateMA(data, period) {
        if (data.length < period) return data[data.length - 1].close

        const sum = data.slice(-period).reduce((acc, d) => acc + d.close, 0)
        return sum / period
      }

      function calculateBollingerBands(data, period = 20) {
        if (data.length < period) return { upper: 0, middle: 0, lower: 0 }

        const prices = data.slice(-period).map((d) => d.close)
        const sma = prices.reduce((a, b) => a + b, 0) / period
        const variance =
          prices.reduce((acc, price) => acc + Math.pow(price - sma, 2), 0) /
          period
        const stdDev = Math.sqrt(variance)

        return {
          upper: sma + stdDev * 2,
          middle: sma,
          lower: sma - stdDev * 2,
        }
      }

      // Enhanced technical analysis with advanced indicators
      function calculateAdvancedIndicators(data) {
        const indicators = {
          // Basic indicators
          rsi: calculateRSI(data),
          macd: calculateMACD(data),
          ma20: calculateMA(data, 20),
          ma50: calculateMA(data, 50),
          ma200: calculateMA(data, 200),

          // Advanced momentum indicators
          stochRSI: calculateStochRSI(data),
          williamsR: calculateWilliamsR(data),
          cci: calculateCCI(data),

          // Volatility indicators
          bb: calculateBollingerBands(data, 20),
          atr: calculateATR(data, 14),
          keltner: calculateKeltnerChannels(data),

          // Volume indicators
          obv: calculateOBV(data),
          vwap: calculateVWAP(data),
          mfi: calculateMFI(data),

          // Trend indicators
          adx: calculateADX(data),
          ichimoku: calculateIchimoku(data),

          // Support/Resistance
          support: calculateSupportLevels(data),
          resistance: calculateResistanceLevels(data),

          // Pattern recognition
          patterns: detectCandlestickPatterns(data),
        }

        return indicators
      }

      // Stochastic RSI
      function calculateStochRSI(data, period = 14) {
        const rsiValues = []
        for (let i = period; i < data.length; i++) {
          rsiValues.push(calculateRSI(data.slice(0, i + 1)))
        }

        if (rsiValues.length < period) return 50

        const recentRSI = rsiValues.slice(-period)
        const minRSI = Math.min(...recentRSI)
        const maxRSI = Math.max(...recentRSI)

        return (
          ((rsiValues[rsiValues.length - 1] - minRSI) / (maxRSI - minRSI)) * 100
        )
      }

      // Williams %R
      function calculateWilliamsR(data, period = 14) {
        if (data.length < period) return -50

        const recent = data.slice(-period)
        const highest = Math.max(...recent.map((d) => d.high))
        const lowest = Math.min(...recent.map((d) => d.low))
        const current = data[data.length - 1].close

        return ((highest - current) / (highest - lowest)) * -100
      }

      // Commodity Channel Index
      function calculateCCI(data, period = 20) {
        if (data.length < period) return 0

        const recent = data.slice(-period)
        const typicalPrices = recent.map((d) => (d.high + d.low + d.close) / 3)
        const sma = typicalPrices.reduce((a, b) => a + b, 0) / period
        const meanDeviation =
          typicalPrices.reduce((sum, tp) => sum + Math.abs(tp - sma), 0) /
          period

        const currentTP =
          (data[data.length - 1].high +
            data[data.length - 1].low +
            data[data.length - 1].close) /
          3
        return (currentTP - sma) / (0.015 * meanDeviation)
      }

      // Average True Range
      function calculateATR(data, period = 14) {
        if (data.length < period + 1) return 0

        const trueRanges = []
        for (let i = 1; i < data.length; i++) {
          const high = data[i].high
          const low = data[i].low
          const prevClose = data[i - 1].close

          const tr1 = high - low
          const tr2 = Math.abs(high - prevClose)
          const tr3 = Math.abs(low - prevClose)

          trueRanges.push(Math.max(tr1, tr2, tr3))
        }

        const recentTR = trueRanges.slice(-period)
        return recentTR.reduce((a, b) => a + b, 0) / period
      }

      // Keltner Channels
      function calculateKeltnerChannels(data, period = 20) {
        const atr = calculateATR(data, period)
        const ema = calculateEMA(data, period)

        return {
          upper: ema + 2 * atr,
          middle: ema,
          lower: ema - 2 * atr,
        }
      }

      // On-Balance Volume
      function calculateOBV(data) {
        let obv = 0
        for (let i = 1; i < data.length; i++) {
          if (data[i].close > data[i - 1].close) {
            obv += data[i].volume
          } else if (data[i].close < data[i - 1].close) {
            obv -= data[i].volume
          }
        }
        return obv
      }

      // Volume Weighted Average Price
      function calculateVWAP(data) {
        let cumulativeTPV = 0
        let cumulativeVolume = 0

        for (const day of data) {
          const typicalPrice = (day.high + day.low + day.close) / 3
          cumulativeTPV += typicalPrice * day.volume
          cumulativeVolume += day.volume
        }

        return cumulativeVolume > 0 ? cumulativeTPV / cumulativeVolume : 0
      }

      // Money Flow Index
      function calculateMFI(data, period = 14) {
        if (data.length < period + 1) return 50

        const moneyFlows = []
        for (let i = 1; i < data.length; i++) {
          const typicalPrice = (data[i].high + data[i].low + data[i].close) / 3
          const prevTypicalPrice =
            (data[i - 1].high + data[i - 1].low + data[i - 1].close) / 3

          const moneyFlow = typicalPrice * data[i].volume
          moneyFlows.push({
            flow: moneyFlow,
            positive: typicalPrice > prevTypicalPrice,
          })
        }

        const recent = moneyFlows.slice(-period)
        const positiveFlow = recent
          .filter((mf) => mf.positive)
          .reduce((sum, mf) => sum + mf.flow, 0)
        const negativeFlow = recent
          .filter((mf) => !mf.positive)
          .reduce((sum, mf) => sum + mf.flow, 0)

        const moneyRatio = positiveFlow / negativeFlow
        return 100 - 100 / (1 + moneyRatio)
      }

      // Average Directional Index
      function calculateADX(data, period = 14) {
        if (data.length < period + 1) return 0

        const directionalMovements = []
        for (let i = 1; i < data.length; i++) {
          const highDiff = data[i].high - data[i - 1].high
          const lowDiff = data[i - 1].low - data[i].low

          let plusDM = 0
          let minusDM = 0

          if (highDiff > lowDiff && highDiff > 0) {
            plusDM = highDiff
          }
          if (lowDiff > highDiff && lowDiff > 0) {
            minusDM = lowDiff
          }

          directionalMovements.push({ plusDM, minusDM })
        }

        const recent = directionalMovements.slice(-period)
        const avgPlusDM =
          recent.reduce((sum, dm) => sum + dm.plusDM, 0) / period
        const avgMinusDM =
          recent.reduce((sum, dm) => sum + dm.minusDM, 0) / period

        const dx =
          (Math.abs(avgPlusDM - avgMinusDM) / (avgPlusDM + avgMinusDM)) * 100
        return dx
      }

      // Ichimoku Cloud
      function calculateIchimoku(data) {
        if (data.length < 52) return null

        const high9 = Math.max(...data.slice(-9).map((d) => d.high))
        const low9 = Math.min(...data.slice(-9).map((d) => d.low))
        const tenkan = (high9 + low9) / 2

        const high26 = Math.max(...data.slice(-26).map((d) => d.high))
        const low26 = Math.min(...data.slice(-26).map((d) => d.low))
        const kijun = (high26 + low26) / 2

        const senkouA = (tenkan + kijun) / 2
        const senkouB =
          (Math.max(...data.slice(-52).map((d) => d.high)) +
            Math.min(...data.slice(-52).map((d) => d.low))) /
          2

        return { tenkan, kijun, senkouA, senkouB }
      }

      // Support and Resistance Levels
      function calculateSupportLevels(data) {
        const lows = data.map((d) => d.low)
        const supportLevels = []

        for (let i = 2; i < lows.length - 2; i++) {
          if (
            lows[i] < lows[i - 1] &&
            lows[i] < lows[i - 2] &&
            lows[i] < lows[i + 1] &&
            lows[i] < lows[i + 2]
          ) {
            supportLevels.push(lows[i])
          }
        }

        return supportLevels.slice(-5) // Return last 5 support levels
      }

      function calculateResistanceLevels(data) {
        const highs = data.map((d) => d.high)
        const resistanceLevels = []

        for (let i = 2; i < highs.length - 2; i++) {
          if (
            highs[i] > highs[i - 1] &&
            highs[i] > highs[i - 2] &&
            highs[i] > highs[i + 1] &&
            highs[i] > highs[i + 2]
          ) {
            resistanceLevels.push(highs[i])
          }
        }

        return resistanceLevels.slice(-5) // Return last 5 resistance levels
      }

      // Candlestick Pattern Detection
      function detectCandlestickPatterns(data) {
        if (data.length < 3) return []

        const patterns = []
        const recent = data.slice(-3)

        // Doji
        const current = recent[recent.length - 1]
        const bodySize = Math.abs(current.close - current.open)
        const totalRange = current.high - current.low

        if (bodySize / totalRange < 0.1) {
          patterns.push("Doji")
        }

        // Hammer
        if (
          bodySize / totalRange < 0.3 &&
          (current.high - Math.max(current.open, current.close)) / totalRange <
            0.1
        ) {
          patterns.push("Hammer")
        }

        // Shooting Star
        if (
          bodySize / totalRange < 0.3 &&
          (Math.min(current.open, current.close) - current.low) / totalRange <
            0.1
        ) {
          patterns.push("Shooting Star")
        }

        return patterns
      }

      // Update UI functions
      function updateStockInfo(symbol, data) {
        const latest = data[data.length - 1]
        const marketCap =
          Math.floor(Math.random() * 1000000000000) + 100000000000
        const sectors = [
          "Technology",
          "Healthcare",
          "Finance",
          "Consumer Goods",
          "Energy",
        ]
        const sector = sectors[Math.floor(Math.random() * sectors.length)]

        stockInfoCard.innerHTML = `
                <div class="card-content">
                    <p class="regular-text">💰 Current Price: <span class="bold-number">$${latest.close.toFixed(
                      2
                    )}</span></p>
                    <p class="regular-text">📈 Market Cap: <span class="bold-number">$${marketCap.toLocaleString()}</span></p>
                    <p class="regular-text">🏢 Sector: <span class="bold-text">${sector}</span></p>
                    <p class="regular-text">📅 Data Points: <span class="bold-number">${
                      data.length
                    } days</span></p>
                    <p class="regular-text">📊 Volume: <span class="bold-number">${latest.volume.toLocaleString()}</span></p>
                </div>
            `
      }

      function updateRecommendation(data) {
        const recommendation = generateRecommendation(data)

        recommendationCard.innerHTML = `
                <div class="card-content">
                    <div class="alert alert-${recommendation.color}">${
          recommendation.recommendation
        } - Confidence: ${recommendation.confidence.toFixed(0)}%</div>
                    <h6 class="bold-text" style="margin-top: 1rem; margin-bottom: 0.5rem;">Key Signals:</h6>
                    <ul>
                        ${recommendation.signals
                          .map((signal) => `<li>${signal}</li>`)
                          .join("")}
                    </ul>
                </div>
            `
      }

      function updateTechnicalAnalysis(data) {
        const recommendation = generateRecommendation(data)
        const indicators = calculateIndicators(data)

        technicalContent.innerHTML = `
                <div class="card-content">
                    <p class="regular-text">RSI: <span class="bold-number">${recommendation.rsi.toFixed(
                      1
                    )}</span></p>
                    <p class="regular-text">Price Change (20d): <span class="bold-number">${
                      recommendation.price_change >= 0 ? "+" : ""
                    }${recommendation.price_change.toFixed(1)}%</span></p>
                    <p class="regular-text">Volume Ratio: <span class="bold-number">${recommendation.volume_ratio.toFixed(
                      1
                    )}x average</span></p>
                    <p class="regular-text">MACD: <span class="bold-number">${indicators.macd.toFixed(
                      3
                    )}</span></p>
                    <p class="regular-text">Data Quality: <span class="bold-text">Good (${
                      data.length
                    } days)</span></p>
                </div>
            `
      }

      function updateRiskAssessment(data) {
        const returns = []
        for (let i = 1; i < data.length; i++) {
          returns.push((data[i].close - data[i - 1].close) / data[i - 1].close)
        }

        const volatility =
          Math.sqrt(
            returns.reduce((sum, r) => sum + r * r, 0) / returns.length
          ) *
          Math.sqrt(252) *
          100
        const maxDrawdown = calculateMaxDrawdown(data)
        const sharpeRatio =
          (returns.reduce((sum, r) => sum + r, 0) /
            returns.length /
            Math.sqrt(
              returns.reduce((sum, r) => sum + r * r, 0) / returns.length
            )) *
          Math.sqrt(252)

        let riskLevel, riskColor
        if (volatility > 30) {
          riskLevel = "High"
          riskColor = "danger"
        } else if (volatility > 20) {
          riskLevel = "Moderate"
          riskColor = "warning"
        } else {
          riskLevel = "Low"
          riskColor = "success"
        }

        riskContent.innerHTML = `
                <div class="card-content">
                    <div class="alert alert-${riskColor}">Risk Level: ${riskLevel}</div>
                    <p class="regular-text">Volatility: <span class="bold-number">${volatility.toFixed(
                      1
                    )}%</span></p>
                    <p class="regular-text">Max Drawdown: <span class="bold-number">${maxDrawdown.toFixed(
                      1
                    )}%</span></p>
                    <p class="regular-text">Sharpe Ratio: <span class="bold-number">${sharpeRatio.toFixed(
                      2
                    )}</span></p>
                    <p class="regular-text">Beta: <span class="bold-text">N/A</span></p>
                </div>
            `
      }

      function calculateMaxDrawdown(data) {
        let maxDrawdown = 0
        let peak = data[0].close

        for (let i = 1; i < data.length; i++) {
          if (data[i].close > peak) {
            peak = data[i].close
          }
          const drawdown = ((data[i].close - peak) / peak) * 100
          if (drawdown < maxDrawdown) {
            maxDrawdown = drawdown
          }
        }

        return Math.abs(maxDrawdown)
      }

      function updateChart(symbol, data) {
        chartContainer.style.display = "block"

        if (currentChart) {
          currentChart.destroy()
        }

        const ctx = priceChart.getContext("2d")
        const chartData = {
          labels: data.map((d) => d.date),
          datasets: [
            {
              label: "Close Price",
              data: data.map((d) => d.close),
              borderColor: "#8b0000",
              backgroundColor: "rgba(139, 0, 0, 0.1)",
              borderWidth: 2,
              fill: false,
            },
          ],
        }

        currentChart = new Chart(ctx, {
          type: "line",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: false,
              },
              legend: {
                labels: {
                  color: "#ffffff",
                },
              },
            },
            scales: {
              x: {
                grid: {
                  color: "rgba(139, 0, 0, 0.2)",
                },
                ticks: {
                  color: "#ffffff",
                  maxTicksLimit: 10,
                },
              },
              y: {
                grid: {
                  color: "rgba(139, 0, 0, 0.2)",
                },
                ticks: {
                  color: "#ffffff",
                },
              },
            },
            layout: {
              padding: {
                top: 10,
                bottom: 10,
              },
            },
          },
        })
      }

      function updateStockTitle(symbol) {
        const companies = {
          AAPL: "Apple Inc.",
          MSFT: "Microsoft Corporation",
          GOOGL: "Alphabet Inc.",
          AMZN: "Amazon.com Inc.",
          TSLA: "Tesla Inc.",
          NVDA: "NVIDIA Corporation",
          META: "Meta Platforms Inc.",
          NFLX: "Netflix Inc.",
        }

        const companyName = companies[symbol] || symbol
        stockTitle.textContent = `📊 ${symbol} - ${companyName}`
      }

      // Utility functions
      function showLoading(message) {
        loadingOutput.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    ${message}
                </div>
            `
      }

      function hideLoading() {
        loadingOutput.innerHTML = ""
      }

      function showError(message) {
        loadingOutput.innerHTML = `
                <div class="error-message">
                    ${message}
                </div>
            `
      }

      // Filter functions
      function setFilter(filter) {
        currentFilter = filter

        // Update active button
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("filter-btn-active")
        })

        switch (filter) {
          case "all":
            filterAll.classList.add("filter-btn-active")
            break
          case "buy":
            filterBuy.classList.add("filter-btn-active")
            break
          case "hold":
            filterHold.classList.add("filter-btn-active")
            break
          case "sell":
            filterSell.classList.add("filter-btn-active")
            break
        }

        updateStockList()
      }

      function updateStockList() {
        if (allStocksData.length === 0) {
          stockListSection.style.display = "none"
          return
        }

        stockListSection.style.display = "block"

        // Filter stocks based on current filter
        let filteredStocks = allStocksData
        if (currentFilter !== "all") {
          filteredStocks = allStocksData.filter(
            (stock) => stock.recommendation.toLowerCase() === currentFilter
          )
        }

        // Sort by confidence (highest first)
        filteredStocks.sort((a, b) => b.confidence - a.confidence)

        // Generate HTML for stock list
        stockList.innerHTML = filteredStocks
          .map(
            (stock) => `
           <div class="stock-item" onclick="selectStock('${stock.symbol}')">
             <div class="stock-item-header">
               <div class="stock-symbol">${stock.symbol}</div>
               <div class="stock-recommendation recommendation-${stock.recommendation.toLowerCase()}">
                 ${stock.recommendation}
               </div>
             </div>
             <div class="stock-details">
               <div class="stock-detail">
                 <div class="stock-detail-label">Price</div>
                 $${stock.price.toFixed(2)}
               </div>
               <div class="stock-detail">
                 <div class="stock-detail-label">Change</div>
                 ${
                   stock.priceChange >= 0 ? "+" : ""
                 }${stock.priceChange.toFixed(1)}%
               </div>
               <div class="stock-detail">
                 <div class="stock-detail-label">Confidence</div>
                 ${stock.confidence.toFixed(0)}%
               </div>
               <div class="stock-detail">
                 <div class="stock-detail-label">RSI</div>
                 ${stock.rsi.toFixed(1)}
               </div>
             </div>
           </div>
         `
          )
          .join("")
      }

      function selectStock(symbol) {
        // Find the stock data
        const stock = allStocksData.find((s) => s.symbol === symbol)
        if (stock) {
          // Update the input and analyze
          symbolInput.value = symbol
          analyzeStock()

          // Scroll to the chart
          chartContainer.scrollIntoView({ behavior: "smooth" })
        }
      }

      // Initialize with default data
      window.addEventListener("load", function () {
        // Auto-analyze AAPL on page load
        setTimeout(() => {
          analyzeStock()
        }, 500)

        // Add some popular stocks for demonstration
        setTimeout(() => {
          const popularStocks = [
            "MSFT",
            "GOOGL",
            "AMZN",
            "TSLA",
            "NVDA",
            "META",
            "NFLX",
          ]
          popularStocks.forEach((symbol, index) => {
            setTimeout(() => {
              symbolInput.value = symbol
              analyzeStock()
            }, (index + 1) * 1000) // Analyze each stock with 1 second delay
          })
        }, 2000)
      })
    </script>
  </body>
</html>
